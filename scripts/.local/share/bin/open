#!/usr/bin/env bash
NAME="open"
OPEN_DRY_RUN=0
VIDEO_PLAYER="clapper"
IMAGE_VIEWER="imv"

usage() {
	"$NAME [FILE|URL] [PATH]"
}

github() {
	dir=$1
	path=$(test -d $dir || echo "$dir does not exist" && exit 1)
	cd $dir
	repo=$(git remote get-url origin || echo "Not in a Git repo." && exit 1)
	url=$(echo $repo | sed "s|git@\([^:]*\):\(.*\)|https:\/\/\1\/\2|")
	[[ $OPEN_DRY_RUN -eq 0 ]] && xdg-open $url || echo "[DRY_RUN]: $url"
}

is_file() {
	return $(file -ib "$arg" | grep -qE "$1")
}

open_as() {
	arg="$1"
	if is_file 'video'; then
		setsid uwsm app -- /usr/bin/"$VIDEO_PLAYER" $1 >/dev/null 2>&1 &
	elif is_file 'image|bitmap'; then
		"$IMAGE_VIEWER" $1
	elif echo $1 | grep -qE 'https://'; then
		xdg-open "$1"
	elif test -d $dir; then
		github $1
	fi
}

if [[ $# == 0 ]]; then
	github $(pwd)
	exit 0
fi

for i in "$@"; do
	case $i in
	-n | --dry-run)
		OPEN_DRY_RUN=1
		shift
		;;
	gh | github)
		github $2
		;;
	help | --help | -h)
		usage
		;;
	esac
	open_as $1
done
